#!/bin/bash
set -euo pipefail

INDEX_PATHS=(
  "index_server/index/inverted_index/inverted_index_0.txt"
  "index_server/index/inverted_index/inverted_index_1.txt"
  "index_server/index/inverted_index/inverted_index_2.txt"
)

PORTS=(9000 9001 9002)

start() {
  echo "starting index server ..."
  mkdir -p var/log
  rm -f var/log/index.log
  for i in "${!INDEX_PATHS[@]}"; do
    INDEX_PATH="${INDEX_PATHS[$i]}"
    PORT="${PORTS[$i]}"
    INDEX_PATH="$INDEX_PATH" flask --app index run --host 0.0.0.0 --port "$PORT" >> var/log/index.log 2>&1 &
  done
}

stop() {
  echo "stopping index server ..."
  for port in "${PORTS[@]}"; do
    pkill -f "flask --app index run --host 0.0.0.0 --port $port" || true
  done
}

status() {
  set +o pipefail
  NPROCS=$(pgrep -f "flask --app index run --host 0.0.0.0 --port 900[0-2]" | wc -l)
  set -o pipefail
  if [ "$NPROCS" -eq 3 ]; then
    echo "index server running"
    exit 0
  elif [ "$NPROCS" -eq 0 ]; then
    echo "index server stopped"
    exit 1
  else
    echo "index server error: found ${NPROCS} processes, expected 3"
    exit 2
  fi
}

case "$1" in
  start)
    status && echo "Error: index server is already running" && exit 1 || start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    start
    ;;
  status)
    status
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac
